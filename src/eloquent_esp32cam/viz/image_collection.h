#ifndef ELOQUENT_ESP32CAM_VIZ_IMAGE_COLLECTION_H
#define ELOQUENT_ESP32CAM_VIZ_IMAGE_COLLECTION_H

#include "../camera/Camera.h"
#include "../extra/exception.h"
#include "../extra/esp32/wifi/sta.h"
#include "../extra/esp32/http/server.h"
#include "./mjpeg.h"

using namespace eloq;
using Eloquent::Error::Exception;
using Eloquent::Extra::Esp32::Http::HttpServer;


namespace Eloquent {
    namespace Esp32cam {
        namespace Viz {
            /**
             * Collect images in browser
             */
            class ImageCollectionServer {
                public:
                    Exception exception;
                    HttpServer server;

                    /**
                     * Constructor
                     */
                    ImageCollectionServer() :
                        exception("ImageCollectionServer"),
                        server("ImageCollectionServer") {

                        }

                    /**
                     * Debug self IP address
                     */
                    String address() const {
                        return String("Image Collection Server is available at http://") + wifi.ip();
                    }

                    /**
                     * Start server
                     */
                    Exception& begin() {
                        if (!viz::mjpeg.begin().isOk())
                            return exception.propagate(viz::mjpeg);

                        onIndex();

                        return server.beginInThread(exception);
                    }

                protected:

                    /**
                     * Display main page
                     */
                    void onIndex() {
                        server.onGET("/", [this](WebServer *web) {
                            static const uint8_t index[8939] = {31, 139, 8, 0, 0, 0, 0, 0, 0, 19, 181, 88, 123, 115, 219, 184, 17, 255, 255, 62, 5, 194, 203, 140, 228, 57, 17, 124, 136, 164, 30, 177, 60, 77, 236, 36, 74, 234, 92, 114, 246, 213, 205, 185, 211, 137, 41, 18, 34, 105, 147, 4, 15, 128, 94, 241, 248, 187, 119, 65, 80, 214, 195, 162, 228, 180, 61, 142, 45, 146, 192, 190, 126, 139, 221, 197, 130, 199, 177, 200, 210, 147, 159, 16, 92, 199, 49, 241, 67, 245, 88, 190, 138, 68, 164, 228, 228, 67, 230, 71, 4, 157, 210, 52, 37, 129, 72, 104, 142, 46, 9, 155, 18, 118, 108, 168, 233, 21, 57, 15, 88, 82, 8, 196, 89, 48, 208, 98, 33, 10, 222, 55, 140, 32, 204, 177, 240, 147, 116, 150, 228, 97, 192, 57, 14, 104, 166, 157, 28, 27, 138, 116, 157, 87, 44, 214, 101, 201, 235, 231, 219, 130, 68, 232, 126, 150, 132, 34, 238, 35, 219, 49, 139, 249, 43, 20, 147, 36, 138, 197, 242, 245, 97, 37, 192, 88, 147, 112, 108, 172, 128, 28, 143, 104, 184, 88, 83, 20, 38, 83, 148, 132, 3, 205, 47, 10, 13, 205, 245, 208, 23, 254, 64, 171, 192, 81, 214, 60, 210, 80, 144, 250, 156, 15, 180, 66, 183, 181, 77, 131, 142, 147, 44, 42, 121, 165, 97, 146, 153, 145, 241, 64, 131, 65, 224, 97, 148, 115, 202, 146, 40, 201, 65, 116, 78, 243, 69, 70, 39, 92, 67, 253, 210, 25, 153, 98, 48, 78, 126, 218, 148, 247, 66, 215, 145, 95, 250, 148, 35, 93, 223, 82, 38, 13, 173, 76, 201, 132, 238, 172, 233, 131, 229, 224, 91, 166, 61, 114, 204, 117, 30, 211, 217, 64, 123, 17, 84, 235, 149, 71, 143, 136, 198, 41, 153, 35, 94, 248, 1, 209, 231, 32, 240, 169, 4, 229, 175, 137, 16, 176, 200, 21, 207, 40, 210, 35, 70, 72, 174, 219, 166, 137, 4, 153, 139, 234, 213, 133, 87, 70, 39, 121, 72, 66, 61, 141, 144, 116, 22, 250, 91, 144, 38, 193, 29, 46, 24, 153, 146, 92, 12, 52, 46, 124, 38, 192, 163, 187, 21, 201, 235, 82, 82, 160, 149, 169, 187, 45, 50, 148, 73, 251, 237, 93, 2, 87, 238, 193, 41, 201, 35, 17, 163, 19, 100, 106, 107, 80, 24, 88, 251, 8, 68, 190, 60, 7, 6, 35, 156, 236, 135, 113, 154, 18, 159, 253, 213, 182, 23, 19, 86, 164, 100, 101, 62, 191, 91, 60, 203, 252, 144, 206, 242, 148, 250, 225, 94, 4, 103, 21, 209, 15, 130, 56, 54, 32, 230, 182, 162, 186, 28, 151, 145, 205, 5, 45, 158, 132, 117, 57, 187, 30, 168, 59, 226, 244, 217, 145, 185, 177, 156, 226, 153, 203, 41, 205, 58, 16, 148, 180, 248, 127, 250, 161, 66, 72, 66, 164, 214, 183, 222, 39, 43, 100, 163, 212, 15, 238, 144, 204, 123, 0, 225, 160, 200, 7, 17, 108, 81, 231, 152, 53, 94, 158, 245, 85, 154, 171, 187, 62, 99, 126, 129, 18, 65, 50, 174, 7, 0, 159, 48, 84, 91, 63, 30, 197, 1, 117, 145, 250, 130, 192, 26, 141, 41, 171, 194, 178, 133, 18, 148, 228, 75, 110, 212, 191, 35, 139, 106, 6, 139, 36, 35, 144, 235, 89, 177, 71, 232, 182, 157, 37, 39, 98, 4, 244, 36, 83, 130, 34, 88, 181, 67, 236, 165, 8, 89, 130, 85, 81, 85, 186, 225, 177, 44, 172, 7, 25, 55, 131, 199, 31, 113, 154, 78, 0, 34, 172, 181, 110, 33, 38, 55, 21, 184, 151, 102, 232, 49, 133, 237, 173, 63, 77, 120, 50, 74, 73, 109, 173, 152, 193, 186, 196, 178, 46, 63, 173, 23, 25, 8, 104, 38, 251, 98, 108, 195, 52, 62, 141, 30, 75, 116, 146, 166, 122, 48, 97, 12, 36, 129, 134, 241, 36, 77, 65, 137, 188, 105, 104, 154, 144, 217, 27, 58, 31, 104, 38, 50, 145, 213, 179, 213, 15, 236, 11, 89, 154, 115, 181, 227, 194, 134, 59, 155, 205, 240, 172, 141, 41, 139, 12, 72, 13, 211, 0, 225, 176, 225, 22, 62, 20, 20, 216, 185, 62, 89, 110, 215, 194, 86, 199, 67, 86, 199, 53, 177, 219, 237, 6, 38, 106, 91, 216, 244, 116, 219, 197, 142, 101, 33, 215, 195, 78, 71, 47, 127, 213, 243, 176, 221, 115, 177, 221, 115, 2, 93, 210, 185, 61, 100, 170, 89, 197, 160, 175, 209, 95, 185, 158, 131, 59, 166, 55, 180, 97, 170, 219, 181, 167, 150, 213, 45, 31, 64, 71, 175, 141, 29, 179, 141, 58, 30, 54, 45, 100, 121, 61, 96, 181, 183, 239, 177, 101, 217, 229, 67, 80, 82, 219, 18, 166, 154, 209, 55, 248, 244, 234, 190, 212, 23, 235, 192, 136, 123, 206, 74, 225, 117, 166, 247, 204, 54, 118, 237, 158, 190, 38, 27, 72, 172, 43, 175, 211, 193, 158, 211, 89, 242, 76, 75, 186, 246, 117, 230, 184, 22, 238, 120, 46, 50, 43, 202, 90, 66, 219, 178, 48, 252, 235, 150, 237, 216, 184, 237, 218, 231, 150, 109, 117, 192, 129, 192, 58, 244, 122, 14, 246, 206, 221, 14, 80, 120, 93, 212, 110, 119, 113, 215, 118, 134, 96, 250, 84, 9, 137, 229, 138, 77, 43, 137, 177, 238, 118, 122, 184, 221, 237, 130, 181, 158, 211, 3, 31, 131, 111, 81, 23, 132, 182, 29, 93, 185, 176, 29, 183, 1, 162, 227, 217, 169, 26, 70, 203, 97, 29, 160, 97, 171, 125, 173, 161, 50, 98, 216, 36, 37, 3, 77, 198, 31, 13, 67, 205, 144, 13, 214, 52, 122, 70, 82, 236, 221, 157, 86, 84, 101, 113, 171, 159, 94, 214, 139, 154, 234, 180, 155, 125, 199, 240, 214, 208, 246, 107, 77, 123, 121, 11, 77, 101, 74, 39, 225, 56, 245, 25, 145, 253, 165, 225, 223, 250, 115, 35, 77, 70, 220, 184, 229, 223, 147, 194, 104, 99, 203, 196, 150, 122, 193, 89, 146, 227, 91, 40, 96, 9, 20, 195, 136, 37, 2, 170, 24, 143, 125, 23, 162, 234, 235, 167, 171, 208, 238, 190, 179, 232, 208, 248, 220, 177, 198, 223, 103, 111, 242, 171, 206, 112, 18, 156, 207, 175, 102, 98, 62, 182, 189, 175, 87, 221, 47, 206, 236, 203, 157, 237, 189, 61, 155, 79, 222, 95, 247, 172, 95, 187, 35, 254, 89, 136, 44, 167, 89, 112, 122, 214, 62, 189, 116, 175, 63, 93, 156, 187, 230, 208, 124, 31, 125, 30, 78, 73, 36, 162, 193, 160, 190, 59, 132, 126, 142, 64, 170, 179, 130, 66, 5, 1, 67, 114, 170, 47, 135, 118, 55, 201, 63, 238, 129, 119, 73, 74, 46, 125, 168, 103, 0, 218, 176, 177, 137, 205, 181, 161, 122, 95, 4, 252, 215, 224, 221, 31, 31, 243, 228, 239, 183, 31, 231, 23, 255, 188, 184, 178, 46, 58, 227, 105, 254, 149, 45, 130, 225, 23, 239, 207, 179, 11, 219, 202, 162, 239, 214, 245, 23, 215, 157, 255, 225, 134, 191, 248, 195, 243, 49, 237, 25, 239, 130, 247, 103, 191, 157, 143, 115, 251, 195, 56, 143, 70, 175, 135, 97, 247, 60, 28, 115, 63, 10, 78, 255, 140, 126, 15, 126, 251, 171, 124, 97, 24, 147, 188, 184, 139, 20, 244, 180, 72, 114, 34, 81, 133, 146, 189, 158, 117, 51, 246, 228, 249, 132, 206, 240, 227, 65, 0, 13, 208, 120, 146, 151, 189, 121, 243, 8, 221, 63, 9, 95, 70, 196, 132, 229, 59, 38, 228, 85, 246, 251, 125, 116, 83, 149, 228, 151, 247, 149, 244, 148, 6, 190, 148, 136, 99, 202, 197, 67, 191, 107, 25, 55, 173, 157, 2, 70, 62, 39, 158, 211, 71, 141, 198, 238, 121, 181, 11, 247, 209, 191, 254, 189, 123, 126, 213, 84, 245, 209, 216, 79, 57, 217, 36, 219, 45, 51, 79, 196, 78, 168, 203, 11, 186, 224, 15, 178, 131, 152, 250, 105, 19, 8, 7, 39, 72, 196, 137, 60, 209, 149, 186, 154, 71, 45, 100, 187, 230, 209, 78, 246, 135, 214, 211, 222, 72, 94, 130, 190, 41, 145, 238, 213, 27, 192, 241, 72, 32, 185, 241, 15, 148, 198, 151, 16, 24, 28, 195, 192, 110, 161, 37, 152, 12, 162, 65, 70, 218, 231, 50, 210, 128, 179, 241, 24, 107, 141, 122, 54, 195, 64, 167, 140, 200, 214, 199, 207, 17, 84, 53, 177, 64, 129, 159, 79, 125, 142, 72, 74, 50, 216, 147, 15, 24, 89, 17, 15, 80, 72, 131, 137, 164, 7, 35, 164, 184, 183, 138, 187, 217, 80, 4, 141, 163, 87, 245, 130, 74, 10, 92, 158, 122, 65, 144, 4, 82, 62, 31, 228, 80, 39, 227, 138, 69, 189, 236, 230, 217, 139, 158, 22, 11, 112, 50, 81, 17, 38, 81, 9, 176, 155, 195, 66, 149, 163, 74, 213, 33, 39, 136, 57, 88, 81, 89, 21, 17, 113, 42, 133, 204, 1, 188, 29, 238, 5, 46, 230, 56, 100, 254, 172, 252, 220, 208, 4, 16, 45, 100, 194, 95, 13, 71, 173, 152, 42, 49, 43, 245, 130, 158, 193, 1, 255, 31, 23, 231, 205, 70, 137, 200, 144, 153, 89, 103, 69, 93, 148, 62, 70, 248, 158, 32, 77, 198, 168, 249, 98, 61, 31, 32, 247, 118, 231, 194, 166, 161, 175, 234, 131, 177, 148, 86, 29, 9, 139, 9, 143, 155, 245, 218, 75, 242, 101, 23, 222, 71, 191, 52, 115, 50, 67, 128, 156, 28, 237, 174, 15, 203, 11, 170, 103, 95, 233, 89, 101, 98, 45, 195, 195, 209, 110, 175, 63, 60, 163, 184, 84, 159, 2, 246, 56, 112, 203, 119, 50, 215, 217, 132, 252, 15, 10, 229, 41, 239, 135, 244, 149, 133, 242, 191, 86, 88, 125, 37, 56, 164, 177, 90, 79, 94, 192, 46, 71, 154, 16, 224, 235, 163, 234, 224, 95, 91, 66, 15, 218, 176, 58, 234, 31, 44, 167, 208, 10, 1, 100, 25, 38, 31, 47, 175, 147, 98, 207, 178, 87, 73, 45, 207, 39, 185, 159, 17, 224, 42, 24, 133, 210, 216, 212, 222, 150, 231, 201, 212, 31, 145, 20, 209, 177, 34, 209, 142, 14, 155, 185, 237, 12, 56, 100, 190, 245, 131, 184, 169, 106, 14, 236, 43, 251, 3, 93, 25, 36, 63, 220, 149, 197, 174, 58, 5, 98, 70, 160, 9, 5, 159, 54, 228, 76, 127, 149, 237, 175, 212, 102, 218, 106, 180, 96, 59, 221, 159, 146, 178, 63, 132, 126, 154, 52, 111, 94, 222, 63, 2, 126, 248, 246, 242, 126, 235, 156, 251, 128, 111, 139, 232, 166, 85, 218, 208, 66, 247, 203, 221, 90, 6, 236, 195, 190, 252, 121, 158, 107, 164, 21, 17, 201, 9, 131, 252, 125, 205, 23, 121, 208, 188, 23, 139, 130, 64, 55, 48, 74, 233, 168, 177, 71, 131, 188, 48, 212, 233, 188, 89, 21, 110, 233, 76, 14, 173, 222, 107, 190, 28, 105, 161, 27, 229, 245, 111, 116, 252, 109, 29, 37, 6, 181, 55, 71, 207, 48, 241, 121, 201, 80, 29, 129, 127, 44, 29, 146, 22, 178, 106, 162, 255, 201, 232, 230, 200, 198, 135, 224, 181, 246, 14, 78, 56, 229, 231, 223, 99, 163, 252, 202, 253, 31, 80, 159, 139, 211, 236, 22, 0, 0};
                            server.sendGzip(index, 8939);
                        });
                    }
            };
        }
    }
}

namespace eloq {
    namespace viz {
        static Eloquent::Esp32cam::Viz::ImageCollectionServer collectionServer;
    }
}

#endif